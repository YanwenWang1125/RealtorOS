name: Quick Update Environment Variables

on:
  workflow_dispatch:
    inputs:
      update_backend:
        description: 'Update backend environment variables'
        required: false
        default: true
        type: boolean
      update_frontend:
        description: 'Update frontend environment variables'
        required: false
        default: false
        type: boolean

env:
  RESOURCE_GROUP: realtoros-rg
  BACKEND_APP_NAME: realtoros-backend
  FRONTEND_APP_NAME: realtoros-frontend
  DB_SERVER_NAME: realtoros-db
  DB_NAME: realtoros
  DB_ADMIN_USER: postgres

jobs:
  update-env:
    name: Update Environment Variables
    runs-on: ubuntu-latest

    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Construct DATABASE_URL from DB_PASSWORD
        run: |
          if [ -z "${{ secrets.DB_PASSWORD }}" ]; then
            echo "❌ ERROR: DB_PASSWORD secret is not set!"
            exit 1
          fi
          
          DB_HOST="${{ env.DB_SERVER_NAME }}.postgres.database.azure.com"
          DB_USER="${{ env.DB_ADMIN_USER }}"
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          DB_NAME="${{ env.DB_NAME }}"
          DATABASE_URL="postgresql+asyncpg://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:5432/${DB_NAME}"
          
          echo "DATABASE_URL=${DATABASE_URL}" >> $GITHUB_ENV
          echo "✅ Constructed DATABASE_URL"
          echo "Database host: ${DB_HOST}"

      - name: Update backend environment variables
        if: ${{ inputs.update_backend }}
        uses: azure/CLI@v1
        with:
          inlineScript: |
            echo "Updating backend environment variables..."
            # Remove old AWS_SES_* variables if they exist (they should use AWS_ACCESS_KEY_ID instead)
            az containerapp update \
              --name ${{ env.BACKEND_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --remove-env-vars AWS_SES_ACCESS_KEY_ID AWS_SES_SECRET_ACCESS_KEY 2>/dev/null || echo "Old AWS_SES_* variables not found (or already removed)"
            
            # Update with correct environment variables
            az containerapp update \
              --name ${{ env.BACKEND_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --set-env-vars \
                ENVIRONMENT=production \
                DEBUG=false \
                API_TITLE="RealtorOS API" \
                API_VERSION="1.0.0" \
                DATABASE_URL="${{ env.DATABASE_URL }}" \
                OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
                OPENAI_MODEL="${{ secrets.OPENAI_MODEL }}" \
                OPENAI_MAX_TOKENS="2000" \
                AWS_REGION="${{ secrets.AWS_REGION }}" \
                SES_FROM_EMAIL="${{ secrets.SES_FROM_EMAIL }}" \
                AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
                AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
                GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
                GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
                SECRET_KEY="${{ secrets.SECRET_KEY }}" \
                ALGORITHM="HS256" \
                ACCESS_TOKEN_EXPIRE_MINUTES="1440" \
                LOG_LEVEL=INFO \
                CORS_ORIGINS="${{ secrets.CORS_ORIGINS }}" \
              --output table
            echo "✅ Backend environment variables updated"

      - name: Get backend URL for frontend
        if: ${{ inputs.update_frontend }}
        id: backend-url
        uses: azure/CLI@v1
        with:
          inlineScript: |
            BACKEND_URL=$(az containerapp show \
              --name ${{ env.BACKEND_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --query properties.configuration.ingress.fqdn -o tsv)
            echo "url=https://$BACKEND_URL" >> $GITHUB_OUTPUT

      - name: Update frontend environment variables
        if: ${{ inputs.update_frontend }}
        uses: azure/CLI@v1
        with:
          inlineScript: |
            echo "Updating frontend environment variables..."
            az containerapp update \
              --name ${{ env.FRONTEND_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --set-env-vars \
                NEXT_PUBLIC_API_URL=${{ steps.backend-url.outputs.url }} \
                NEXT_PUBLIC_GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
              --output table
            echo "✅ Frontend environment variables updated"

      - name: Summary
        run: |
          echo "### Environment Variables Updated! ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.update_backend }}" = "true" ] || [ "${{ inputs.update_backend }}" = true ]; then
            echo "✅ Backend environment variables updated" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.update_frontend }}" = "true" ] || [ "${{ inputs.update_frontend }}" = true ]; then
            echo "✅ Frontend environment variables updated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Containers will restart automatically with new environment variables." >> $GITHUB_STEP_SUMMARY

